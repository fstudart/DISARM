Author: Dr. Fernando Sergio S. Leitao Filho
Center for Heart Lung Innovation – University of British Columbia
E-mail: Fernando.Studart@hli.ubc.ca

SEQUENCING DATA COMES FROM TWO BATCHES: 
BATCH 1: All samples collected at both time points were included in this batch, except for those related to Disarm participant 85 (who was randomized to the Formoterol arm). 
For this participant, his samples collected during the first bronchoscopy visit were also included in batch 1. 

Batch 2: Contains all samples collected at the second bronchocopy visit of the Disarm participant 85. 

Note: File "Attributes.tsv" available in folder DISARM/Files_used_analysis indicates which samples were originated from each batch.

QIIME2 VERSION USED IN THIS ANALSYS: 2020.2

PART I - BATCH 1

#IMPORTING DATA
#Place all fastq.gz files (both forward and reverse files from Batch 1) into the same folder; in this example: Fastq-R1.
#Note: All sequencing data are already demultiplexed.

qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path Fastq-R1 \
  --input-format CasavaOneEightSingleLanePerSampleDirFmt \
  --output-path Disarm-only-demux-paired-end1.qza
  
 qiime demux summarize \
  --i-data Disarm-only-demux-paired-end1.qza \
  --o-visualization Disarm-only-demux-paired-end1.qzv

#DENOISING TH SEQUENCING DATA
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs Disarm-only-demux-paired-end1.qza \
  --o-table Disarm-only-samples-dada2-run1.qza \
  --p-n-threads 0 \
  --o-representative-sequences Disarm-only-rep-seqs-run1.qza \
  --p-trim-left-f 12 \
  --p-trim-left-r 12 \
  --p-trunc-len-f 242 \
  --p-trunc-len-r 133 \
  --o-denoising-stats Disarm-only-samples-denoising-stats-run1.qza
 
qiime feature-table summarize \
  --i-table Disarm-only-samples-dada2-run1.qza \
  --o-visualization Disarm-only-samples-dada2-run1.qzv

qiime metadata tabulate \
  --m-input-file Disarm-only-samples-denoising-stats-run1.qza \
  --o-visualization Disarm-only-samples-denoising-stats-run1.qzv

qiime feature-table tabulate-seqs \
  --i-data Disarm-only-rep-seqs-run1.qza \
  --o-visualization Disarm-only-rep-seqs-run1.qzv

#SEQUENCING QUALITY CONTROL (USING THE SILVA DATABASE V132 WITH 99% COVERAGE)
qiime quality-control exclude-seqs \
  --i-query-sequences Disarm-only-rep-seqs-run1.qza \
  --i-reference-sequences Silva132-99-ref-seqs.qza \
  --p-method blast \
  --p-perc-identity 0.80 \
  --p-perc-query-aligned 0.80 \
  --o-sequence-hits hits-run1.qza \
  --o-sequence-misses misses-run1.qza

qiime feature-table tabulate-seqs \
  --i-data hits-run1.qza \
  --o-visualization hits-run1.qzv
  
qiime feature-table tabulate-seqs \
  --i-data misses-run1.qza \
  --o-visualization misses-run1.qzv

qiime feature-table filter-features \
  --i-table Disarm-only-samples-dada2-run1.qza \
  --m-metadata-file misses-run1.qza \
  --o-filtered-table Disarm-only-samples-dada2-run1-filtered.qza \
  --p-exclude-ids

qiime feature-table summarize \
  --i-table Disarm-only-samples-dada2-run1-filtered.qza \
  --o-visualization Disarm-only-samples-dada2-run1-filtered.qzv

qiime feature-table filter-seqs \
--i-data Disarm-only-rep-seqs-run1.qza \
--i-table Disarm-only-samples-dada2-run1-filtered.qza \
--o-filtered-data Disarm-only-rep-seqs-run1-filtered.qza

qiime feature-table tabulate-seqs \
  --i-data Disarm-only-rep-seqs-run1-filtered.qza \
  --o-visualization Disarm-only-rep-seqs-run1-filtered.qzv

#TAXONOMIC CLASSIFICATION (USING THE SILVA DATABASE V132 WITH 99% COVERAGE)
qiime feature-classifier classify-sklearn \
  --i-classifier Silva132-classifier-my-primers-majority-v-0.22.1.qza \
  --i-reads Disarm-only-rep-seqs-run1-filtered.qza \
  --p-reads-per-batch 2000 \
  --p-n-jobs -2 \
  --o-classification Disarm-only-rep-seqs-run1-filtered-SILVA132-taxonomy.qza \
  --verbose

qiime metadata tabulate \
  --m-input-file Disarm-only-rep-seqs-run1-filtered-SILVA132-taxonomy.qza \
  --o-visualization Disarm-only-rep-seqs-run1-filtered-SILVA132-taxonomy.qzv

qiime metadata tabulate \
--m-input-file Disarm-only-rep-seqs-run1-filtered.qza \
--m-input-file Disarm-only-rep-seqs-run1-filtered-SILVA132-taxonomy.qza \
--o-visualization Disarm-only-rep-seqs-run1-filtered-SILVA132-taxonomy-tabulated.qzv

#File "Disarm_Library_Prep_full_simplified-R1.txt" available in folder DISARM/Files_used_analysis/
qiime taxa barplot \
  --i-table Disarm-only-samples-dada2-run1-filtered.qza \
  --i-taxonomy Disarm-only-rep-seqs-run1-filtered-SILVA132-taxonomy.qza \
  --m-metadata-file Disarm_Library_Prep_full_simplified-R1.txt \
  --o-visualization Disarm-only-taxa-bar-plots-run1-filtered-Silva132.qzv

#REMOVING ASVS IDENTIFIED AS POTENTIAL CONTAMINANTS ACCORDING TO THE DECONTAM R PACKAGE
#File "Decontam-frequency-Batch1.txt" available in folder DISARM/Files_used_analysis/
qiime feature-table filter-features \
--i-table Disarm-only-samples-dada2-run1-filtered.qza \
--m-metadata-file Decontam-Run1/Decontam-frequency-Batch1.txt \
--p-exclude-ids \
--o-filtered-table Decontam-Run1/Disarm-only-samples-dada2-run1-filtered-after-decontam.qza

qiime feature-table summarize \
  --i-table Decontam-Run1/Disarm-only-samples-dada2-run1-filtered-after-decontam.qza \
  --o-visualization Decontam-Run1/Disarm-only-samples-dada2-run1-filtered-after-decontam.qzv

qiime feature-table filter-seqs \
--i-data Disarm-only-rep-seqs-run1-filtered.qza \
--i-table Decontam-Run1/Disarm-only-samples-dada2-run1-filtered-after-decontam.qza \
--o-filtered-data Decontam-Run1/Disarm-only-rep-seqs-run1-filtered-after-decontam.qza

qiime metadata tabulate \
  --m-input-file Decontam-Run1/Disarm-only-rep-seqs-run1-filtered-after-decontam.qza \
  --o-visualization Decontam-Run1/Disarm-only-rep-seqs-run1-filtered-after-decontam.qzv

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
PART II - BATCH 2

#IMPORTING DATA 
#Place all fastq.gz files (both forward and reverse files from Batch 2) into the same folder; in this example: Fastq-R2.
#Note: All sequencing data are already demultiplexed.

qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path Fastq-R2 \
  --input-format CasavaOneEightSingleLanePerSampleDirFmt \
  --output-path Disarm-only-demux-paired-end2.qza
  
 qiime demux summarize \
  --i-data Disarm-only-demux-paired-end2.qza \
  --o-visualization Disarm-only-demux-paired-end2.qzv

#DENOISING DATA (using the same trimming parameters as Batch 1)
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs Disarm-only-demux-paired-end2.qza \
  --o-table Disarm-only-samples-dada2-run2.qza \
  --p-n-threads 0 \
  --o-representative-sequences Disarm-only-rep-seqs-run2.qza \
  --p-trim-left-f 12 \
  --p-trim-left-r 12 \
  --p-trunc-len-f 242 \
  --p-trunc-len-r 133 \
  --o-denoising-stats Disarm-only-samples-denoising-stats-run2.qza
 
qiime feature-table summarize \
  --i-table Disarm-only-samples-dada2-run2.qza \
  --o-visualization Disarm-only-samples-dada2-run2.qzv

qiime metadata tabulate \
  --m-input-file Disarm-only-samples-denoising-stats-run2.qza \
  --o-visualization Disarm-only-samples-denoising-stats-run2.qzv

qiime feature-table tabulate-seqs \
  --i-data Disarm-only-rep-seqs-run2.qza \
  --o-visualization Disarm-only-rep-seqs-run2.qzv

#SEQUENCING QUALITY CONTROL (USING THE SILVA DATABASE V132 WITH 99% COVERAGE)
qiime quality-control exclude-seqs \
  --i-query-sequences Disarm-only-rep-seqs-run2.qza \
  --i-reference-sequences Silva132-99-ref-seqs.qza \
  --p-method blast \
  --p-perc-identity 0.80 \
  --p-perc-query-aligned 0.80 \
  --o-sequence-hits hits-run2.qza \
  --o-sequence-misses misses-run2.qza

qiime feature-table tabulate-seqs \
  --i-data hits-run2.qza \
  --o-visualization hits-run2.qzv
  
qiime feature-table tabulate-seqs \
  --i-data misses-run2.qza \
  --o-visualization misses-run2.qzv

qiime feature-table filter-features \
  --i-table Disarm-only-samples-dada2-run2.qza \
  --m-metadata-file misses-run2.qza \
  --o-filtered-table Disarm-only-samples-dada2-run2-filtered.qza \
  --p-exclude-ids

qiime feature-table summarize \
  --i-table Disarm-only-samples-dada2-run2-filtered.qza \
  --o-visualization Disarm-only-samples-dada2-run2-filtered.qzv

qiime feature-table filter-seqs \
--i-data Disarm-only-rep-seqs-run2.qza \
--i-table Disarm-only-samples-dada2-run2-filtered.qza \
--o-filtered-data Disarm-only-rep-seqs-run2-filtered.qza

qiime feature-table tabulate-seqs \
  --i-data Disarm-only-rep-seqs-run2-filtered.qza \
  --o-visualization Disarm-only-rep-seqs-run2-filtered.qzv

#TAXONOMIC CLASSIFICATION
qiime feature-classifier classify-sklearn \
  --i-classifier Silva132-classifier-my-primers-majority-v-0.22.1.qza \
  --i-reads Disarm-only-rep-seqs-run2-filtered.qza \
  --p-reads-per-batch 2000 \
  --p-n-jobs -2 \
  --o-classification Disarm-only-rep-seqs-run2-filtered-SILVA132-taxonomy.qza \
  --verbose

qiime metadata tabulate \
  --m-input-file Disarm-only-rep-seqs-run2-filtered-SILVA132-taxonomy.qza \
  --o-visualization Disarm-only-rep-seqs-run2-filtered-SILVA132-taxonomy.qzv

qiime metadata tabulate \
--m-input-file Disarm-only-rep-seqs-run2-filtered.qza \
--m-input-file Disarm-only-rep-seqs-run2-filtered-SILVA132-taxonomy.qza \
--o-visualization Disarm-only-rep-seqs-run2-filtered-SILVA132-taxonomy-tabulated.qzv

#File "Disarm_Library_Prep_full_simplified-R2.txt" available in folder DISARM/Files_used_analysis/
qiime taxa barplot \
  --i-table Disarm-only-samples-dada2-run2-filtered.qza \
  --i-taxonomy Disarm-only-rep-seqs-run2-filtered-SILVA132-taxonomy.qza \
  --m-metadata-file Disarm_Library_Prep_full_simplified-R2.txt \
  --o-visualization Disarm-only-taxa-bar-plots-run2-filtered-Silva132.qzv

#REMOVING ASVS IDENTIFIED AS POTENTIAL CONTAMINANTS ACCORDING TO THE DECONTAM R PACKAGE
#File "Decontam-frequency-Batch2.txt" available in folder DISARM/Files_used_analysis/
qiime feature-table filter-features \
--i-table Disarm-only-samples-dada2-run1-filtered.qza \
--m-metadata-file Decontam-Run2/Decontam-frequency-Batch2.txt \
--p-exclude-ids \
--o-filtered-table Decontam-Run2/Disarm-only-samples-dada2-run2-filtered-after-decontam.qza

qiime feature-table summarize \
  --i-table Decontam-Run2/Disarm-only-samples-dada2-run2-filtered-after-decontam.qza \
  --o-visualization Decontam-Run2/Disarm-only-samples-dada2-run2-filtered-after-decontam.qzv

qiime feature-table filter-seqs \
--i-data Disarm-only-rep-seqs-run2-filtered.qza \
--i-table Decontam-Run2/Disarm-only-samples-dada2-run2-filtered-after-decontam.qza \
--o-filtered-data Decontam-Run2/Disarm-only-rep-seqs-run2-filtered-after-decontam.qza

qiime metadata tabulate \
  --m-input-file Decontam-Run2/Disarm-only-rep-seqs-run2-filtered-after-decontam.qza \
  --o-visualization Decontam-Run2/Disarm-only-rep-seqs-run2-filtered-after-decontam.qzv

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
PART III - MERGING BATCHES 1 AND 2

qiime feature-table merge \
  --i-tables Run1/Disarm-only-samples-dada2-run1-filtered.qza \
  --i-tables Run2/Disarm-only-samples-dada2-run2-filtered.qza \
  --o-merged-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered.qza

qiime feature-table summarize \
  --i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered.qza \
  --m-sample-metadata-file Runs-combined/Disarm_Library_Prep_full_simplified_combined.txt \
  --o-visualization Runs-combined/Disarm-only-samples-dada2-both-runs-filtered.qzv 

qiime feature-table merge-seqs \
  --i-data Run1/Disarm-only-rep-seqs-run1-filtered.qza \
  --i-data Run2/Disarm-only-rep-seqs-run2-filtered.qza \
  --o-merged-data Runs-combined/Disarm-only-rep-seqs-both-runs-filtered.qza

qiime feature-table tabulate-seqs \
  --i-data Runs-combined/Disarm-only-rep-seqs-both-runs-filtered.qza \
  --o-visualization Runs-combined/Disarm-only-rep-seqs-both-runs-filtered.qzv

#Removing singletons and low abundant taxa
qiime feature-table filter-features \
  --i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered.qza \
  --p-min-samples 2 \
  --p-min-frequency 10 \
  --o-filtered-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency.qza

#File "Disarm_Library_Prep_full_simplified_combined.txt" available in folder DISARM/Files_used_analysis/
qiime feature-table summarize \
  --i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency.qza \
  --m-sample-metadata-file Runs-combined/Disarm_Library_Prep_full_simplified_combined.txt \
  --o-visualization Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency.qzv

qiime feature-table filter-seqs \
--i-data Runs-combined/Disarm-only-rep-seqs-both-runs-filtered.qza \
--i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency.qza \
--o-filtered-data Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency.qza

qiime feature-table tabulate-seqs \
  --i-data Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency.qza \
  --o-visualization Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency.qzv

qiime feature-classifier classify-sklearn \
  --i-classifier Runs-combined/Silva132-classifier-my-primers-majority-v-0.22.1.qza \
  --i-reads Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency.qza \
  --p-reads-per-batch 2000 \
  --o-classification Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy.qza \
  --verbose

qiime metadata tabulate \
  --m-input-file Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy.qza \
  --o-visualization Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy.qzv

qiime metadata tabulate \
--m-input-file Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency.qza \
--m-input-file Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy.qza \
--o-visualization Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy-tabulated.qzv

#File "Disarm_Library_Prep_full_simplified_combined.txt" available in folder DISARM/Files_used_analysis/
qiime taxa barplot \
  --i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency.qza \
  --i-taxonomy Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy.qza \
  --m-metadata-file Runs-combined/Disarm_Library_Prep_full_simplified_combined.txt \
  --o-visualization Runs-combined/Disarm-only-taxa-bar-plots-both-runs-filtered-Silva132.qzv

#Removing other known contaminants (Mitochondria, Chloroplast, and Archaea) and only keeping ASVs with at least taxonomic annotations at the phylum level
qiime taxa filter-table \
  --i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency.qza \
  --i-taxonomy Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy.qza \
  --p-include D_1__\
  --p-exclude mitochondria,chloroplast,archaea  \
  --o-filtered-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency-phyla.qza 

#File "Disarm_Library_Prep_full_simplified_combined.txt" available in folder DISARM/Files_used_analysis/
qiime feature-table summarize \
  --i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency-phyla.qza \
  --m-sample-metadata-file Runs-combined/Disarm_Library_Prep_full_simplified_combined.txt \
  --o-visualization Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency-phyla.qzv

qiime feature-table filter-seqs \
--i-data Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency.qza \
--i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency-phyla.qza \
--o-filtered-data Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-phyla.qza

qiime metadata tabulate \
  --m-input-file Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-phyla.qza \
  --o-visualization Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-phyla.qzv

#File "Disarm_Library_Prep_full_simplified_combined.txt" available in folder DISARM/Files_used_analysis/
qiime taxa barplot \
  --i-table Runs-combined/Disarm-only-samples-dada2-both-runs-filtered-contingency-phyla.qza \
  --i-taxonomy Runs-combined/Disarm-only-rep-seqs-both-runs-filtered-contingency-taxonomy.qza \
  --m-metadata-file Runs-combined/Disarm_Library_Prep_full_simplified_combined.txt \
  --o-visualization Runs-combined/Disarm-only-taxa-bar-plots-both-runs-filtered-Silva132-phyla.qzv





















qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path Sputum-112-Samples \
  --input-format CasavaOneEightSingleLanePerSampleDirFmt \
  --output-path Sputum.qza

#Obtaining summary of sequencing data from sputum samples after being imported into QIIME2®
qiime demux summarize \
  --i-data Sputum.qza \
  --o-visualization Sputum.qzv

#Performing sequence quality control and feature table construction using DADA2 denoising algorithm
#Note: the trimming options used below may be changed
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs Sputum.qza \
  --o-table Sputum-dada2.qza\
  --p-n-threads 0 \
  --o-representative-sequences Sputum-rep-seqs.qza \
  --p-trim-left-f 13 \
  --p-trim-left-r 13 \
  --p-trunc-len-f 241 \
  --p-trunc-len-r 175 \
  --o-denoising-stats Sputum-denoising-stats.qza

qiime feature-table summarize \
  --i-table Sputum-dada2.qza \
  --o-visualization Sputum-dada2.qzv

qiime feature-table tabulate-seqs \
  --i-data Sputum-rep-seqs.qza \
  --o-visualization Sputum-rep-seqs.qzv

qiime metadata tabulate \
  --m-input-file Sputum-denoising-stats.qza \
  --o-visualization Sputum-denoising-stats.qzv

#Extraction Negative Controls
#Place all fastq.gz files (both forward and reverse files from the seven extraction negative controls) into the same folder; 
 in this example: EN-7-Samples
#Note: All sequencing data already demultiplexed!
qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path EN-7-Samples \
  --input-format CasavaOneEightSingleLanePerSampleDirFmt \
  --output-path EN.qza

#Obtaining summary of sequencing data from extraction negative controls after being imported into QIIME2®
qiime demux summarize \
  --i-data EN.qza \
  --o-visualization EN.qzv

#Performing sequence quality control and feature table construction using DADA2 denoising algorithm
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs EN.qza \
  --o-table EN-dada2.qza\
  --p-n-threads 0 \
  --o-representative-sequences EN-rep-seqs.qza \
  --p-trim-left-f 13 \
  --p-trim-left-r 13 \
  --p-trunc-len-f 241 \
  --p-trunc-len-r 175 \
  --o-denoising-stats EN-denoising-stats.qza

qiime feature-table summarize \
  --i-table EN-dada2.qza \
  --o-visualization EN-dada2.qzv

qiime feature-table tabulate-seqs \
  --i-data EN-rep-seqs.qza \
  --o-visualization EN-rep-seqs.qzv

qiime metadata tabulate \
  --m-input-file EN-denoising-stats.qza \
  --o-visualization EN-denoising-stats.qzv

#Selecting ASVs observed in at least 3 out of 7 extraction negative controls
qiime feature-table filter-features \
  --i-table EN-dada2.qza \
  --p-min-samples 3 \
  --o-filtered-table EN-data2-contingency-filtered-table.qza

qiime feature-table summarize \
  --i-table EN-data2-contingency-filtered-table.qza \
  --o-visualization EN-data2-contingency-filtered-table.qzv

#Visualize and export features (i.e., ASVs) observed in EN-data2-contingency-filtered-table.qza using Qiime2View 
#After exporting, save this new file as Sequences-at-least3-controls.tsv
#Keep only ASVs (EN-rep-seqs.qza) present in Sequences-at-least3-controls.tsv 
qiime feature-table filter-seqs \
--i-data EN-rep-seqs.qza \
--m-metadata-file Sequences-at-least3-controls.tsv \
--p-no-exclude-ids \
--o-filtered-data EN-rep-seqs-atleast3-controls.qza

qiime feature-table tabulate-seqs \
  --i-data EN-rep-seqs-atleast3-controls.qza \
  --o-visualization EN-rep-seqs-atleast3-controls.qzv

#Obtaining taxonomic annotations for ASVs present in EN-rep-seqs-atleast3-controls.qza
qiime feature-classifier classify-sklearn \
  --i-classifier Silva132-16s_99_7_levels_classifier250-myprimers.qza \
  --i-reads EN-rep-seqs-atleast3-controls.qza \
  --o-classification Taxonomy-EN-rep-seqs-atleast3-controls.qza

qiime metadata tabulate \
  --m-input-file Taxonomy-EN-rep-seqs-atleast3-controls.qza \
  --o-visualization Taxonomy-EN-rep-seqs-atleast3-controls.qzv

#Removing ASVs (Sputum-dada2.qza) observed in Sequences-at-least3-controls.tsv
qiime feature-table filter-features \
  --i-table Sputum-dada2.qza \
  --m-metadata-file Sequences-at-least3-controls.tsv \
  --p-exclude-ids \
  --o-filtered-table Filtered-Sputum-dada2.qza

qiime feature-table summarize \
  --i-table Filtered-Sputum-dada2.qza \
  --o-visualization Filtered-Sputum-dada2.qzv

#Removing noise (excluding singletons and low abundant features – frequency < 10 across all samples)
qiime feature-table filter-features \
  --i-table Filtered-Sputum-dada2.qza \
  --p-min-samples 2 \
  --p-min-frequency 10 \
  --o-filtered-table Filtered-Sputum-table-contingency-table.qza

qiime feature-table summarize \
  --i-table Filtered-Sputum-table-contingency-table.qza \
  --o-visualization Filtered-Sputum-table-contingency-table.qzv

#Visualize and export features (i.e., ASVs) observed in Filtered-Sputum-table-contingency-table.qza using Qiime2View
#After exporting, save this new file as "Seqs-to-keep-after-controls-at-least3-and-removal-low-abundant-features.tsv"
#Keep only ASVs (Sputum-rep-seqs.qza) observed in Seqs-to-keep-after-controls-at-least3-and-removal-low-abundant-features.tsv 

qiime feature-table filter-seqs \
--i-data Sputum-rep-seqs.qza \
--m-metadata-file Seqs-to-keep-after-controls-at-least3-and-removal-low-abundant-features.tsv \
--p-no-exclude-ids \
--o-filtered-data Filtered-Sputum-rep-seqs.qza

qiime feature-table tabulate-seqs \
  --i-data Filtered-Sputum-rep-seqs.qza \
  --o-visualization Filtered-Sputum-rep-seqs.qzv

#Performing taxonomic analysis (to identify ASVs with no taxonomic annotations at the phylum level)
#Taxonomic database: Silva 132
qiime feature-classifier classify-sklearn \
  --i-classifier Silva132-16s_99_7_levels_classifier250-myprimers.qza \
  --i-reads Filtered-Sputum-rep-seqs.qza \
  --o-classification Sputum-Taxonomy132-before-phylum-annotation.qza

qiime metadata tabulate \
  --m-input-file Sputum-Taxonomy132-before-phylum-annotation.qza \
  --o-visualization Sputum-Taxonomy132-before-phylum-annotation.qzv

#Removing noise (excluding ASVs with no taxonomic annotation at the phylum level and contaminants - non-bacterial DNA)
qiime taxa filter-table \
  --i-table Filtered-Sputum-table-contingency-table.qza \
  --i-taxonomy Sputum-Taxonomy132-before-phylum-annotation.qza \
  --p-include D_1__\
  --p-exclude mitochondria,chloroplast,archaea \
  --o-filtered-table Filtered-Sputum-table-contingency-table-with-phylum.qza

qiime feature-table summarize \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum.qza \
  --o-visualization Filtered-Sputum-table-contingency-table-with-phylum.qzv

#Removing samples with very low number of reads (these samples would be removed during rarefaction step for alpha and beta 
diversity analyses)
#Samples removed: COPD-049; COPD-086; COPD-090; COPD-093.

qiime feature-table filter-samples \
--i-table Filtered-Sputum-table-contingency-table-with-phylum.qza \
--m-metadata-file Samples-to-not-keep-for-rarefaction-4.tsv \
--p-exclude-ids \
--o-filtered-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza

qiime feature-table summarize \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
  --o-visualization Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qzv \
  --m-sample-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv 

#Visualize and export features (i.e., ASVs) observed in Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza 
  using Qiime2View => save as Final-Sputum-features-to-keep.tsv
#Keep only ASVs (Filtered-Sputum-rep-seqs.qza) present in Final-Sputum-features-to-keep.tsv

qiime feature-table filter-seqs \
--i-data Filtered-Sputum-rep-seqs.qza \
--m-metadata-file Final-Sputum-features-to-keep.tsv \
--p-no-exclude-ids \
--o-filtered-data Final-Sputum-rep-seqs.qza

qiime feature-table tabulate-seqs \
  --i-data Final-Sputum-rep-seqs.qza \
  --o-visualization Final-Sputum-rep-seqs.qzv

#Making tree file (using Final-Sputum-rep-seqs.qza) 
qiime alignment mafft \
  --i-sequences Final-Sputum-rep-seqs.qza \
  --o-alignment aligned-Final-Sputum-rep-seqs.qza

qiime alignment mask \
  --i-alignment aligned-Final-Sputum-rep-seqs.qza \
  --o-masked-alignment masked-Final-Sputum-rep-seqs.qza 

qiime phylogeny fasttree \
  --i-alignment masked-Final-Sputum-rep-seqs.qza \
  --o-tree unrooted-tree-Final-Sputum.qza

qiime phylogeny midpoint-root \
  --i-tree unrooted-tree-Final-Sputum.qza \
  --o-rooted-tree rooted-tree-Final-Sputum.qza

#Final taxonomic analysis
#Taxonomic database: Silva 132
qiime feature-classifier classify-sklearn \
  --i-classifier Silva132-16s_99_7_levels_classifier250-myprimers.qza \
   --i-reads Final-Sputum-rep-seqs.qza \
  --o-classification Final-Taxonomy132-after-phylum-102-samples.qza

qiime metadata tabulate \
  --m-input-file Final-Taxonomy132-after-phylum-102-samples.qza \
  --o-visualization Final-Taxonomy132-after-phylum-102-samples.qzv

qiime taxa barplot \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
  --i-taxonomy Final-Taxonomy132-after-phylum-102-samples.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --o-visualization Final-taxa-bar-plots-Silva132-with-phylum-rarefaction.qzv

#Alpha and beta diversity analyses – 102 patients 
#Rarefaction cut off: 6,430 (lowest number of reads observed across all samples)

qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree-Final-Sputum.qza \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
  --p-sampling-depth 6430 \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --output-dir core-metrics-results

#Move to Core-metric-results folder
#Copy metadata file (102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv) to Core-metric-results folder
#Alpha diversity 

qiime diversity alpha-group-significance \
  --i-alpha-diversity faith_pd_vector.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --o-visualization faith-pd-group-significance.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity observed_otus_vector.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --o-visualization observed-otu-group-significance.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity shannon_vector.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --o-visualization shannon-group-significance.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity evenness_vector.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --o-visualization evenness-group-significance.qzv

#Note: export the raw data for each alpha diversity metric and save into one single file 
#There is an option to download the raw data when visualizing each .qzv file using Qiime2View.
#Here, we are saving as “RTC-sputum-alpha-diversity-from-Qiime2.txt”

#Beta diversity – Unweighted Unifrac
qiime diversity beta-group-significance \
  --i-distance-matrix unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --m-metadata-column Mortality_1Year\
  --o-visualization Mortality-unweighted-unifrac-significance.qzv \
  --p-pairwise

#Beta-diversity - Weighted Unifrac
qiime diversity beta-group-significance \
  --i-distance-matrix weighted_unifrac_distance_matrix.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --m-metadata-column Mortality_1Year\
  --o-visualization Mortality-weighted-unifrac-significance.qzv \
  --p-pairwise

#Beta-diversity – Bray Curtis
qiime diversity beta-group-significance \
  --i-distance-matrix bray_curtis_distance_matrix.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --m-metadata-column Mortality_1Year \
  --o-visualization Mortality-bray-curtis-significance.qzv \
  --p-pairwise

#Beta-diversity - Jaccard
qiime diversity beta-group-significance \
  --i-distance-matrix jaccard_distance_matrix.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --m-metadata-column Mortality_1Year\
  --o-visualization Mortality-jaccard-significance.qzv \
  --p-pairwise

#Beta-diversity Generalized Unifrac (alpha 0.5)
#Plugin used: beta-phylogenetic-alt: Beta diversity (phylogenetic) - High Performance Computation
#Move one directory up: cd .. 
#Obtaining feature table at the same sampling depth (rarefaction cut-off: 6,430 reads)

qiime feature-table rarefy \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
  --p-sampling-depth 6430 \
  --o-rarefied-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction-6430.qza

qiime feature-table summarize \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction-6430.qza \
  --o-visualization Filtered-Sputum-table-contingency-table-with-phylum-rarefaction-6430.qzv \
  --m-sample-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv

#Obtaining Generalized Unifrac distance matrix using rarefied feature table
qiime diversity beta-phylogenetic-alt \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction-6430.qza \
  --i-phylogeny rooted-tree-Final-Sputum.qza \
  --p-metric generalized_unifrac \
  --p-alpha 0.5 \
  --o-distance-matrix core-metrics-results/Mortality-alpha-0.5-generalized_unifrac_distance_matrix.qza

#Move to Core-metric-results folder
#Performing beta diversity analysis using Generalized Unifrac distance matrix (alpha 0.5)
qiime diversity beta-group-significance \
  --i-distance-matrix Mortality-alpha-0.5-generalized_unifrac_distance_matrix.qza \
  --m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
  --m-metadata-column Mortality_1Year \
  --o-visualization Mortality-alpha-0.5-generalized_unifrac-significance.qzv \
  --p-pairwise

#Obtaining PCoA file and emperor plot related to Generalized Unifrac distance matrix (alpha 0.5)
qiime diversity pcoa \
--i-distance-matrix Mortality-alpha-0.5-generalized_unifrac_distance_matrix.qza \
--o-pcoa Mortality-alpha-0.5-generalized_unifrac_pcoa_results.qza

qiime emperor plot \
--i-pcoa Mortality-alpha-0.5-generalized_unifrac_pcoa_results.qza \
--m-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv \
--o-visualization Mortality-alpha-0.5-generalized_unifrac_emperor.qzv

#Exporting Generalized Unifrac distance matrix (alpha 0.5)

qiime tools export \
 --input-path Mortality-alpha-0.5-generalized_unifrac_distance_matrix.qza \
 --output-path exported

#Renaming exported GU distance matrix
mv exported/distance-matrix.tsv exported/GU-distance-matrix.txt

#Move one directory up: cd .. 
#Collapsing Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza at the genus level
#Taxonomic database: Silva 132

qiime taxa collapse \
  --i-table Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
  --i-taxonomy Final-Taxonomy132-after-phylum-102-samples.qza \
  --p-level 6 \
  --o-collapsed-table Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza

qiime feature-table summarize \
  --i-table Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
  --o-visualization Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qzv \
  --m-sample-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv 

#Exporting collapsed feature table (Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza): 
  provides number of reads for all taxa (up to genus level) across all samples (according to SampleID)

qiime tools export \
 --input-path Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
 --output-path Collapsed-Table

#Renaming exported collapsed feature table
mv Collapsed-Table/feature-table.biom Collapsed-Table/Collapsed-all-samples-method.biom

#Converting BIOM file (Collapsed-all-samples-method.biom) to tsv format
biom convert -i Collapsed-Table/Collapsed-all-samples-method.biom \
  -o Collapsed-Table/collapsed-all-samples.tsv \
  --to-tsv --header-key taxonomy

#Creating presence or absence feature table from Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza
qiime feature-table presence-absence \
--i-table Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
--o-presence-absence-table Binary-Collapsed-Table/Binary-Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
--output-dir Binary-Collapsed-Table

qiime feature-table summarize \
  --i-table Binary-Collapsed-Table/Binary-Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
  --o-visualization Binary-Collapsed-Table/Binary-Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qzv \
  --m-sample-metadata-file 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.tsv

#Exporting binary collapsed feature table (Binary-Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza): provides information regarding presence or absence for all taxa (up to genus level) across all samples (according to SampleID)

qiime tools export \
 --input-path Binary-Collapsed-Table/Binary-Collapsed-Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
 --output-path Binary-Collapsed-Table

#Renaming exported binary collapsed feature table
mv Binary-Collapsed-Table/feature-table.biom Binary-Collapsed-Table/Binary-Collapsed-all-samples-method.biom

#Converting BIOM file (Binary-Collapsed-all-samples-method.biom) to tsv format
biom convert -i Binary-Collapsed-Table/Binary-Collapsed-all-samples-method.biom \
  -o Binary-Collapsed-Table/Binary-Collapsed-all-samples.tsv \
  --to-tsv --header-key taxonomy

#Exporting Feature Table (Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza) as BIOM file
qiime tools export \
 --input-path Filtered-Sputum-table-contingency-table-with-phylum-rarefaction.qza \
 --output-path Exported

#Renaming BIOM file to 102-Sputum-not-rarefied.biom
mv Exported/feature-table.biom Exported/102-Sputum-not-rarefied.biom

#Exporting Taxonomic File (Final-Taxonomy132-after-phylum-102-samples.qza) 
qiime tools export \
 --input-path Final-Taxonomy132-after-phylum-102-samples.qza \
 --output-path Exported

#Change the first line of taxonomy.tsv (i.e., the header) to: #OTUID; taxonomy; confidence
#Save this new file as "taxonomy1.tsv"
#Editing taxonomy1.tsv to remove D_0__; D_1__,… (Optional)
#Adding taxonomic information to BIOM file (102-Sputum-not-rarefied.biom)

biom add-metadata -i Exported/102-Sputum-not-rarefied.biom -o Exported/102-Sputum-not-rarefied-with-taxonomy.biom --observation-metadata-fp Exported/taxonomy1.tsv --sc-separated taxonomy

#Exporting Feature Table – rarefied (Filtered-Sputum-table-contingency-table-with-phylum-rarefaction-6430.qza) as BIOM file
qiime tools export \
 --input-path Filtered-Sputum-table-contingency-table-with-phylum-rarefaction-6430.qza \
 --output-path Exported

#Renaming BIOM file to 102-Sputum-rarefied.biom
mv Exported/feature-table.biom Exported/102-Sputum-rarefied.biom

#Adding taxonomic information to BIOM file (102-Sputum-rarefied.biom)
biom add-metadata -i Exported/102-Sputum-rarefied.biom -o Exported/102-Sputum-rarefied-with-taxonomy.biom --observation-metadata-fp Exported/taxonomy1.tsv --sc-separated taxonomy

#Exporting Tree file (rooted-tree-Final-Sputum.qza) 
qiime tools export \
 --input-path rooted-tree-Final-Sputum.qza \
 --output-path Exported

Part II – R 
#Create a new folder (In our case: Sputum-Mortality-Paper-codes)
#Copy the following files to this folder:
1) Metadata file: 102-patients-Sputum-25-AUG-2018-all-1-year-follow-up.txt (change extension from .tsv to .txt)
2) BIOM file (rarefied): 102-Sputum-rarefied-with-taxonomy.biom (for alpha and beta diversity analyses)
3) BIOM file (not rarefied): 102-Sputum-not-rarefied-with-taxonomy.biom (for making taxa bar plots at phylum and genus levels)
4) Tree file: tree.nwk
5) File with values of alpha diversity metrics (Richness, Shannon, Evenness and Faith’s PD - obtained from QIIME2): 
   RTC-sputum-alpha-diversity-from-Qiime2.txt (This is Optional!)
6) Generalized Unifrac distance matrix (alpha=0.5) exported from QIIME2: GU-distance-matrix.txt
